# USIサーバー実行方法

USIサーバーを起動して将棋エンジンと接続する手順です。

## 前提条件

- Node.js（v14以上）またはPython（3.7以上）がインストールされていること
- USI対応の将棋エンジンが用意されていること

## Node.js版の実行方法

### 1. 依存パッケージのインストール

```bash
cd d:\Cursor\ShogiServer
npm install
```

### 2. コンフィグファイルの設定（オプション）

複数のサーバーを異なるポートで起動する場合は、`config.json`ファイルを作成します。

```json
{
  "servers": [
    {
      "name": "server1",
      "port": 8080,
      "enginePath": "./dlshogi-dr2_exhi/dlshogi_tensorrt.exe",
      "autoConnect": true
    },
    {
      "name": "server2",
      "port": 8081,
      "enginePath": "./dlshogi-dr2_exhi/dlshogi_tensorrt.exe",
      "autoConnect": false
    }
  ]
}
```

詳細は `CONFIG.md` を参照してください。

### 3. サーバーの起動

#### 方法A: npmコマンドで起動（推奨）

```bash
npm start
```

#### 方法B: 直接nodeで起動

```bash
node server.js
```

#### 方法C: エンジンパスを指定して起動（コンフィグファイルがない場合）

**PowerShellの場合:**
```powershell
$env:ENGINE_PATH=".\your_engine.exe"
node server.js
```

**コマンドプロンプトの場合:**
```cmd
set ENGINE_PATH=.\your_engine.exe
node server.js
```

### 4. 起動確認

サーバーが正常に起動すると、以下のようなメッセージが表示されます：

```
========================================
USIサーバー起動
========================================

[USI Server server1] サーバーが起動しました: http://localhost:8080
[USI Server server2] サーバーが起動しました: http://localhost:8081
[USI Server server3] サーバーが起動しました: http://localhost:8082

========================================
合計 3 個のサーバーが起動しました
========================================

  - server1: http://localhost:8080
  - server2: http://localhost:8081
  - server3: http://localhost:8082
```

### 5. ヘルスチェック

各サーバーのヘルスチェックエンドポイントにアクセスして確認：

```bash
# サーバー1
curl http://localhost:8080/health

# サーバー2
curl http://localhost:8081/health

# サーバー3
curl http://localhost:8082/health
```

正常な場合、以下のようなJSONが返されます：

```json
{
  "status": "ok",
  "serverName": "server1",
  "port": 8080,
  "engineRunning": false,
  "engineReady": false,
  "engineName": ""
}
```

## Python版の実行方法

### 1. 依存パッケージのインストール

```bash
cd d:\Cursor\ShogiServer
pip install -r requirements.txt
```

### 2. サーバーの起動

#### 方法A: 直接pythonで起動

```bash
python server.py
```

#### 方法B: エンジンパスを指定して起動

**PowerShellの場合:**
```powershell
$env:ENGINE_PATH=".\your_engine.exe"
python server.py
```

**コマンドプロンプトの場合:**
```cmd
set ENGINE_PATH=.\your_engine.exe
python server.py
```

### 3. 起動確認

サーバーが正常に起動すると、以下のメッセージが表示されます：

```
USIサーバーが起動しました: http://localhost:8080
エンジンパスを環境変数 ENGINE_PATH で指定できます
例: ENGINE_PATH=./engine.exe python server.py
 * Running on http://0.0.0.0:8080
```

## 将棋ゲームでの使用方法

1. **USIサーバーを起動**（上記の手順）

2. **将棋ゲームを開く**
   - `d:\Cursor\ShogiGame\index.html` をブラウザで開く
   - または、ローカルサーバーで起動：
     ```bash
     cd d:\Cursor\ShogiGame
     python -m http.server 8000
     ```
     その後、`http://localhost:8000` にアクセス

3. **USIエンジンを選択**
   - 「AI強さ」から「USIエンジン」を選択
   - USI設定が表示されるので、必要に応じてサーバーURLを確認・変更
   - デフォルト: `http://localhost:8080`

4. **ゲーム開始**
   - 「プレイモード」で「人間 vs AI」または「AI vs AI」を選択
   - ゲームを開始すると、USIエンジンが自動的に接続されます

## エンジンの接続方法

### 方法1: 環境変数で指定（起動時）

```powershell
# PowerShell
$env:ENGINE_PATH=".\dlshogi-dr2_exhi\YaneuraOu-by-gcc.exe"
node server.js
```

### 方法2: リクエストで指定（実行時）

サーバー起動後、以下のAPIを呼び出してエンジンを接続：

```bash
curl -X POST http://localhost:8080/usi/connect \
  -H "Content-Type: application/json" \
  -d '{"enginePath": "./dlshogi-dr2_exhi/YaneuraOu-by-gcc.exe"}'
```

## トラブルシューティング

### ポート8080が既に使用されている

別のポートを使用する場合は、`server.js`または`server.py`の`PORT`変数を変更してください。

### エンジンが起動しない

1. エンジンのパスが正しいか確認
2. エンジンが実行可能なファイルか確認
3. エンジンのログを確認（サーバーのコンソールに表示されます）

### CORSエラーが発生する

サーバーのCORS設定は自動的に有効になっています。エラーが発生する場合は：
- サーバーが正常に起動しているか確認
- ブラウザのコンソールでエラーメッセージを確認

### 思考がタイムアウトする

- エンジンの処理速度を確認
- エンジンの設定を調整
- `timeLimit`パラメータを増やす

## 開発モード（Node.js版のみ）

ファイル変更を自動検知して再起動する開発モード：

```bash
npm run dev
```

※ `nodemon`がインストールされている必要があります

## サーバーの停止

サーバーを停止するには、実行中のターミナルで `Ctrl+C` を押してください。

エンジンが起動している場合は、自動的に`quit`コマンドが送信され、エンジンも終了します。




