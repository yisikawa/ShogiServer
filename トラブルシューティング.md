# トラブルシューティングガイド

## エンジンが起動していない場合

### 症状
ヘルスチェック（`/health`）で以下の状態：
```json
{
  "status": "ok",
  "engineRunning": false,
  "engineReady": false,
  "engineName": ""
}
```

### 原因と対策

#### 1. エンジンが接続されていない

**対策**: エンジンを接続するAPIを呼び出す

```bash
# PowerShell
curl -X POST http://localhost:8080/usi/connect `
  -H "Content-Type: application/json" `
  -d '{\"enginePath\": \"./dlshogi-dr2_exhi/dlshogi_tensorrt.exe\"}'
```

または、ブラウザのコンソールで：
```javascript
fetch('http://localhost:8080/usi/connect', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    enginePath: './dlshogi-dr2_exhi/dlshogi_tensorrt.exe'
  })
}).then(r => r.json()).then(console.log);
```

#### 2. エンジンパスが間違っている

**確認方法**:
- エンジンファイルが存在するか確認
- パスが正しいか確認（相対パスまたは絶対パス）

**対策**: 正しいパスを指定

```powershell
# 絶対パスで指定
$env:ENGINE_PATH="d:\Cursor\ShogiServer\dlshogi-dr2_exhi\dlshogi_tensorrt.exe"
node server.js
```

#### 3. エンジンがUSIプロトコルに対応していない

**確認方法**: エンジンを直接実行してUSIコマンドを送信

```bash
# エンジンを直接実行
.\dlshogi-dr2_exhi\dlshogi_tensorrt.exe

# その後、以下を入力
usi
```

**期待される応答**:
```
id name dlshogi
id author ...
option name ...
usiok
```

#### 4. エンジンの起動に失敗している

**確認方法**: サーバーのコンソールでエラーメッセージを確認

**対策**: 
- エンジンが実行可能か確認
- 必要なDLLや依存ファイルが揃っているか確認
- エンジンのログを確認

## エンジン接続の完全な手順

### ステップ1: サーバーを起動

```powershell
cd d:\Cursor\ShogiServer
npm start
```

### ステップ2: エンジンを接続

```powershell
# PowerShell
$body = @{
    enginePath = ".\dlshogi-dr2_exhi\dlshogi_tensorrt.exe"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/usi/connect" `
    -Method POST `
    -ContentType "application/json" `
    -Body $body
```

### ステップ3: エンジンを初期化

```powershell
Invoke-RestMethod -Uri "http://localhost:8080/usi/usi" `
    -Method POST `
    -ContentType "application/json"
```

### ステップ4: 状態を確認

```powershell
Invoke-RestMethod -Uri "http://localhost:8080/health" `
    -Method GET
```

正常な場合：
```json
{
  "status": "ok",
  "engineRunning": true,
  "engineReady": true,
  "engineName": "dlshogi"
}
```

## 自動接続機能の追加（推奨）

サーバー起動時に自動的にエンジンを接続するように設定できます。

### 方法1: 環境変数で指定

```powershell
$env:ENGINE_PATH=".\dlshogi-dr2_exhi\dlshogi_tensorrt.exe"
npm start
```

### 方法2: 設定ファイルを作成

`config.json`を作成：
```json
{
  "defaultEngine": "./dlshogi-dr2_exhi/dlshogi_tensorrt.exe",
  "autoConnect": true
}
```

## よくあるエラーと解決方法

### エラー: "エンジンが起動していません"

**原因**: `/usi/connect`を呼び出していない

**解決**: 上記の「ステップ2: エンジンを接続」を実行

### エラー: "エンジンの初期化がタイムアウトしました"

**原因**: 
- エンジンがUSIプロトコルに対応していない
- エンジンの起動に時間がかかりすぎている

**解決**:
1. エンジンを直接実行してUSIコマンドをテスト
2. タイムアウト時間を延長（`server.js`の`setTimeout`を調整）

### エラー: "エンジン起動エラー"

**原因**: 
- エンジンのパスが間違っている
- エンジンが実行できない（権限、依存ファイル不足など）

**解決**:
1. エンジンのパスを確認
2. エンジンを直接実行して動作確認
3. 必要なDLLや設定ファイルが揃っているか確認

## デバッグ方法

### サーバーのログを確認

サーバーのコンソールに以下のようなログが表示されます：

```
エンジンを起動: ./dlshogi-dr2_exhi/dlshogi_tensorrt.exe
→ エンジン: usi
← エンジン: id name dlshogi
← エンジン: usiok
```

### エンジンのログを確認

エンジンがstderrに出力するログを確認：
```
エンジンエラー: [エラーメッセージ]
```

### ネットワークリクエストを確認

ブラウザの開発者ツール（F12）のNetworkタブで、APIリクエストとレスポンスを確認




