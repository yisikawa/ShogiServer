# エンジンクラッシュ対策

エラーコード `3221225477` (0xC0000005) はアクセス違反（Access Violation）エラーです。

## エラーの意味

- **エラーコード**: `3221225477` (10進数) = `0xC0000005` (16進数)
- **意味**: アクセス違反 - 無効なメモリアクセス
- **原因**: 
  - メモリ不足
  - エンジンの内部バグ
  - 不正なメモリアクセス

## 対策

### 1. メモリ使用量を確認

```powershell
# メモリ使用量を確認
Get-Process | Where-Object {$_.ProcessName -like "*dlshogi*"} | Select-Object ProcessName, WorkingSet, PagedMemorySize
```

### 2. エンジンの設定を調整

エンジンの設定でメモリ使用量を減らす：

- `UCT_NodeLimit` を減らす（デフォルト: 10000000）
- `UCT_Threads` を減らす（デフォルト: 2）
- `DNN_Batch_Size` を減らす（デフォルト: 128）

### 3. エンジンを再起動する

エンジンがクラッシュした場合、自動的に再起動する機能を追加できます。

### 4. 別のエンジンを試す

- `dlshogi_tensorrt.exe` の代わりに `dlshogi_onnxruntime.exe` を試す
- または、より軽量なエンジンを使用

## サーバーの改善

サーバーコードは既に以下の改善を実施済み：

1. **エンジン終了時のエラーハンドリング**: 思考中のリクエストに対してエラーレスポンスを返す
2. **エラーコードの詳細表示**: 16進数での表示と原因の説明
3. **レスポンス重複送信の防止**: `responseSent`フラグで制御

## 推奨される設定

### メモリ制限を設定

エンジンの起動時にメモリ制限を設定：

```javascript
// server.js の startEngine 関数内
engineProcess = spawn(normalizedPath, [], {
    stdio: ['pipe', 'pipe', 'pipe'],
    cwd: engineDir,
    shell: false,
    // Windowsではメモリ制限の設定が難しいため、
    // エンジンの設定で制限する
});
```

### エンジン設定の調整

思考開始前にエンジンの設定を調整：

```javascript
// UCT_NodeLimitを減らす
sendCommand('setoption name UCT_NodeLimit value 5000000');
// UCT_Threadsを減らす
sendCommand('setoption name UCT_Threads value 1');
```

## 一時的な回避策

エンジンが頻繁にクラッシュする場合：

1. **思考時間を短くする**: `timeLimit`を減らす（例: 3000ms）
2. **エンジンを再起動**: クラッシュ後、手動で再接続
3. **別のエンジンを使用**: より安定したエンジンに切り替え

## デバッグ方法

### エンジンのログを確認

サーバーのコンソールに表示されるエラーメッセージを確認：

```
エンジンエラー: [エラーメッセージ]
```

### エンジンを直接実行

エンジンを直接実行して、同じエラーが発生するか確認：

```powershell
cd d:\Cursor\ShogiServer\dlshogi-dr2_exhi
.\dlshogi_onnxruntime.exe
```

その後、USIコマンドを手動で送信：

```
usi
isready
position startpos
go byoyomi 30
```

同じエラーが発生する場合、エンジン自体の問題の可能性があります。



