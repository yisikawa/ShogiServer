# エンジン接続手順

現在、エンジンが起動していない状態です。以下の手順でエンジンを接続してください。

## 方法1: APIで接続（推奨）

### PowerShellで実行

```powershell
# エンジンを接続
$body = @{
    enginePath = ".\dlshogi-dr2_exhi\dlshogi_tensorrt.exe"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/usi/connect" `
    -Method POST `
    -ContentType "application/json" `
    -Body $body
```

### curlで実行

```bash
curl -X POST http://localhost:8080/usi/connect ^
  -H "Content-Type: application/json" ^
  -d "{\"enginePath\": \"./dlshogi-dr2_exhi/dlshogi_tensorrt.exe\"}"
```

### ブラウザのコンソールで実行

1. ブラウザで `http://localhost:8080/health` を開く
2. F12で開発者ツールを開く
3. コンソールタブで以下を実行：

```javascript
fetch('http://localhost:8080/usi/connect', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    enginePath: './dlshogi-dr2_exhi/dlshogi_tensorrt.exe'
  })
})
.then(r => r.json())
.then(data => {
  console.log('接続結果:', data);
  // 初期化も実行
  return fetch('http://localhost:8080/usi/usi', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  });
})
.then(r => r.json())
.then(data => {
  console.log('初期化結果:', data);
  // 状態確認
  return fetch('http://localhost:8080/health');
})
.then(r => r.json())
.then(data => console.log('最終状態:', data));
```

## 方法2: 環境変数で自動接続

サーバー起動時に自動的にエンジンを接続するには、環境変数を設定します。

### PowerShell

```powershell
$env:ENGINE_PATH=".\dlshogi-dr2_exhi\dlshogi_tensorrt.exe"
npm start
```

### コマンドプロンプト

```cmd
set ENGINE_PATH=.\dlshogi-dr2_exhi\dlshogi_tensorrt.exe
npm start
```

## 接続後の確認

接続後、以下のコマンドで状態を確認：

```powershell
Invoke-RestMethod -Uri "http://localhost:8080/health" -Method GET
```

正常な場合：
```json
{
  "status": "ok",
  "engineRunning": true,
  "engineReady": true,
  "engineName": "dlshogi"
}
```

## エンジンの初期化

接続後、エンジンを初期化する必要があります：

```powershell
Invoke-RestMethod -Uri "http://localhost:8080/usi/usi" `
    -Method POST `
    -ContentType "application/json"
```

## 完全な接続スクリプト

以下のPowerShellスクリプトを実行すると、接続から初期化まで自動で行います：

```powershell
# エンジン接続
$connectBody = @{
    enginePath = ".\dlshogi-dr2_exhi\dlshogi_tensorrt.exe"
} | ConvertTo-Json

Write-Host "エンジンを接続中..."
$connectResult = Invoke-RestMethod -Uri "http://localhost:8080/usi/connect" `
    -Method POST `
    -ContentType "application/json" `
    -Body $connectBody

Write-Host "接続結果: $($connectResult | ConvertTo-Json)"

# 少し待機
Start-Sleep -Seconds 2

# エンジン初期化
Write-Host "エンジンを初期化中..."
$initResult = Invoke-RestMethod -Uri "http://localhost:8080/usi/usi" `
    -Method POST `
    -ContentType "application/json"

Write-Host "初期化結果: $($initResult | ConvertTo-Json)"

# 状態確認
Write-Host "状態を確認中..."
$health = Invoke-RestMethod -Uri "http://localhost:8080/health" -Method GET
Write-Host "最終状態: $($health | ConvertTo-Json)"
```

このスクリプトを `connect-engine.ps1` として保存して実行できます。




